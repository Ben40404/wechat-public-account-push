# é’é¾™é¢æ¿å¾®ä¿¡æ¨é€è‡ªåŠ¨åŒ–å·¥ä½œæµ - åˆå®‰
# åŸºäºé’é¾™è„šæœ¬çš„å¾®ä¿¡å…¬ä¼—å·æ¨é€æœåŠ¡
name: qinglong-wechat-push-noon

on:
  workflow_dispatch:
  schedule:
    # æ¯å¤© UTC 06:30 è¿è¡Œ, å³åŒ—äº¬æ—¶é—´ 14:30 è¿è¡Œ
    - cron: '30 6 * * *'

jobs:
  validate-and-push:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]

    steps:
    # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        ref: 'master'

    # æ­¥éª¤ 2: è®¾ç½® Node.js ç¯å¢ƒ
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    # æ­¥éª¤ 3: ç¯å¢ƒå˜é‡éªŒè¯
    - name: éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
      env:
        # â¬‡ï¸ è¿™é‡Œæ”¹æˆ NOON çš„ secretï¼Œç¯å¢ƒå˜é‡åå­—ä»ç„¶å« ALL_CONFIG
        ALL_CONFIG: ${{ secrets.ALL_CONFIG_NOON || vars.ALL_CONFIG_NOON }}
      run: |
        echo "ğŸ” å¼€å§‹éªŒè¯ç¯å¢ƒå˜é‡é…ç½®..."

        # æ£€æŸ¥ ALL_CONFIG æ˜¯å¦å­˜åœ¨
        if [ -z "${ALL_CONFIG}" ]; then
          echo "âŒ é”™è¯¯ï¼šALL_CONFIG_NOON ç¯å¢ƒå˜é‡æœªé…ç½®"
          echo "è¯·ç¡®ä¿åœ¨ GitHub Secrets ä¸­è®¾ç½®äº† ALL_CONFIG_NOON"
          exit 1
        fi

        echo "âœ… ALL_CONFIG_NOON ç¯å¢ƒå˜é‡å·²é…ç½®"

        # éªŒè¯ JSON æ ¼å¼ â€”â€” ğŸ‘‡ è¿™æ•´æ®µ python3 -c çš„å†…å®¹åŸå°ä¸åŠ¨æ‹·è´å³å¯
        echo "ğŸ” éªŒè¯ ALL_CONFIG JSON æ ¼å¼..."
        echo "${ALL_CONFIG}" > /tmp/config.json
        python3 -c "
        import json
        import sys
        try:
            with open('/tmp/config.json', 'r') as f:
                config = json.load(f)
            print('âœ… ALL_CONFIG JSON æ ¼å¼æ­£ç¡®')

            # éªŒè¯å¿…éœ€çš„é…ç½®é¡¹
            if 'TEMPLATE_CONFIG' not in config:
                print('âŒ é”™è¯¯ï¼šTEMPLATE_CONFIG é…ç½®é¡¹ç¼ºå¤±')
                sys.exit(1)

            if not config['TEMPLATE_CONFIG'] or len(config['TEMPLATE_CONFIG']) == 0:
                print('âŒ é”™è¯¯ï¼šTEMPLATE_CONFIG ä¸èƒ½ä¸ºç©ºæ•°ç»„')
                sys.exit(1)

            print(f'âœ… å·²æ‰¾åˆ° {len(config[\"TEMPLATE_CONFIG\"])} ä¸ªæ¨¡æ¿é…ç½®')

            if 'USER_INFO' not in config:
                print('âŒ é”™è¯¯ï¼šUSER_INFO é…ç½®é¡¹ç¼ºå¤±')
                sys.exit(1)

            if not config['USER_INFO'] or len(config['USER_INFO']) == 0:
                print('âŒ é”™è¯¯ï¼šUSER_INFO ä¸èƒ½ä¸ºç©ºæ•°ç»„')
                sys.exit(1)

            print(f'âœ… å·²æ‰¾åˆ° {len(config[\"USER_INFO\"])} ä¸ªç”¨æˆ·é…ç½®')

            # éªŒè¯ç”¨æˆ·é…ç½®
            for i, user in enumerate(config['USER_INFO']):
                if 'useTemplateId' not in user:
                    print(f'âŒ é”™è¯¯ï¼šç”¨æˆ· {i+1} ç¼ºå°‘ useTemplateId é…ç½®')
                    sys.exit(1)

                # æ£€æŸ¥æ¨é€æ¸ é“é…ç½®
                has_wechat = 'id' in user and 'wechatTemplateId' in user
                has_pushdeer = 'pushDeerKey' in user

                if not has_wechat and not has_pushdeer:
                    print(f'âŒ é”™è¯¯ï¼šç”¨æˆ· {i+1} å¿…é¡»é…ç½®å¾®ä¿¡æµ‹è¯•å·æˆ– PushDeer æ¨é€æ¸ é“')
                    sys.exit(1)

            print('âœ… æ‰€æœ‰ç”¨æˆ·é…ç½®éªŒè¯é€šè¿‡')
            print('âœ… ç¯å¢ƒå˜é‡éªŒè¯å®Œæˆ')

        except json.JSONDecodeError as e:
            print(f'âŒ é”™è¯¯ï¼šALL_CONFIG JSON æ ¼å¼é”™è¯¯ - {e}')
            sys.exit(1)
        except Exception as e:
            print(f'âŒ é”™è¯¯ï¼šéªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ - {e}')
            sys.exit(1)
        "
        rm -f /tmp/config.json

    # æ­¥éª¤ 4: å®‰è£…é’é¾™è„šæœ¬ä¾èµ–
    - name: å®‰è£…é’é¾™è„šæœ¬ä¾èµ–
      working-directory: ./qinglong
      run: |
        echo "ğŸ“¦ æ­£åœ¨å®‰è£…é’é¾™è„šæœ¬ä¾èµ–..."
        npm install
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    # æ­¥éª¤ 5: è¿è¡Œé’é¾™æ¨é€è„šæœ¬
    - name: è¿è¡Œé’é¾™æ¨é€è„šæœ¬
      working-directory: ./qinglong
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡Œé’é¾™æ¨é€è„šæœ¬ï¼ˆåˆå®‰ï¼‰..."
        node qinglong-push.js
        echo "âœ… æ¨é€ä»»åŠ¡å®Œæˆ"
      env:
        # â¬‡ï¸ è¿™é‡ŒåŒæ ·æ”¹æˆ NOON çš„ secret
        ALL_CONFIG: ${{ secrets.ALL_CONFIG_NOON || vars.ALL_CONFIG_NOON }}

    # æ­¥éª¤ 6: è¿è¡Œç»“æœé€šçŸ¥
    - name: è¿è¡Œç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… é’é¾™å¾®ä¿¡ã€åˆå®‰ã€‘æ¨é€ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
        else
          echo "âŒ é’é¾™å¾®ä¿¡ã€åˆå®‰ã€‘æ¨é€ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
        fi
