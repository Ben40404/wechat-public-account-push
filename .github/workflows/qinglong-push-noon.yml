# é’é¾™é¢æ¿å¾®ä¿¡æŽ¨é€è‡ªåŠ¨åŒ–å·¥ä½œæµ - åˆå®‰
name: qinglong-wechat-push-noon

on:
  workflow_dispatch:
  schedule:
    # æ¯å¤© UTC 04:30 è¿è¡Œ, å³åŒ—äº¬æ—¶é—´ 12:30
    - cron: '30 6 * * *'

jobs:
  validate-and-push:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        ref: 'master'

    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: éªŒè¯å¿…éœ€çš„çŽ¯å¢ƒå˜é‡
      env:
        ALL_CONFIG: ${{ secrets.ALL_CONFIG_NOON || vars.ALL_CONFIG_NOON }}
      run: |
        echo "ðŸ” å¼€å§‹éªŒè¯ ALL_CONFIG_NOON..."
        if [ -z "${ALL_CONFIG}" ]; then
          echo "âŒ é”™è¯¯ï¼šALL_CONFIG_NOON æœªé…ç½®"
          exit 1
        fi
        echo "${ALL_CONFIG}" > /tmp/config.json
        python3 - << 'PYCODE'
import json, sys
try:
    with open('/tmp/config.json','r',encoding='utf-8') as f:
        config = json.load(f)
    if 'TEMPLATE_CONFIG' not in config or not config['TEMPLATE_CONFIG']:
        print('âŒ é”™è¯¯ï¼šTEMPLATE_CONFIG ç¼ºå¤±æˆ–ä¸ºç©º'); sys.exit(1)
    if 'USER_INFO' not in config or not config['USER_INFO']:
        print('âŒ é”™è¯¯ï¼šUSER_INFO ç¼ºå¤±æˆ–ä¸ºç©º'); sys.exit(1)
    for i, user in enumerate(config['USER_INFO']):
        if 'useTemplateId' not in user:
            print(f'âŒ é”™è¯¯ï¼šç”¨æˆ· {i+1} ç¼ºå°‘ useTemplateId'); sys.exit(1)
        has_wechat = 'id' in user and 'wechatTemplateId' in user
        has_pushdeer = 'pushDeerKey' in user
        if not has_wechat and not has_pushdeer:
            print(f'âŒ é”™è¯¯ï¼šç”¨æˆ· {i+1} æœªé…ç½®æŽ¨é€æ¸ é“'); sys.exit(1)
    print('âœ… ALL_CONFIG_NOON éªŒè¯é€šè¿‡')
except Exception as e:
    print(f'âŒ é”™è¯¯ï¼šéªŒè¯å¼‚å¸¸ - {e}'); sys.exit(1)
PYCODE
        rm -f /tmp/config.json

    - name: å®‰è£…é’é¾™è„šæœ¬ä¾èµ–
      working-directory: ./qinglong
      run: |
        echo "ðŸ“¦ æ­£åœ¨å®‰è£…é’é¾™è„šæœ¬ä¾èµ–..."
        npm install
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: è¿è¡Œé’é¾™æŽ¨é€è„šæœ¬
      working-directory: ./qinglong
      env:
        ALL_CONFIG: ${{ secrets.ALL_CONFIG_NOON || vars.ALL_CONFIG_NOON }}
      run: |
        echo "ðŸš€ å¼€å§‹è¿è¡Œé’é¾™æŽ¨é€è„šæœ¬(åˆå®‰)..."
        node qinglong-push.js
        echo "âœ… æŽ¨é€ä»»åŠ¡å®Œæˆ"

    - name: è¿è¡Œç»“æžœé€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… åˆå®‰æŽ¨é€ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
        else
          echo "âŒ åˆå®‰æŽ¨é€ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—æŽ’æŸ¥"
